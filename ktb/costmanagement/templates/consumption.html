<!DOCTYPE html>
{% load staticfiles %}
<html lang="en">

<head>
   <!-- Required meta tags-->
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
   <!-- Title Page-->
   <title>Blending & Consumption</title>
   <!-- Fontfaces CSS-->
   <link href="{% static 'costmanagement/css/font-face.css' %}" rel="stylesheet" media="all">
   <!-- <link href="{% static 'costmanagement/vendor/font-awesome-5/css/fontawesome-all.min.css' %}" rel="stylesheet" media="all"> -->
   <link href="{% static 'costmanagement/vendor/font-awesome-4.7/css/font-awesome.min.css' %}" rel="stylesheet"
      media="all">
   <link href="{% static 'costmanagement/vendor/mdi-font/css/material-design-iconic-font.min.css' %}" rel="stylesheet"
      media="all">
   <!-- Bootstrap CSS-->
   <link href="{% static 'costmanagement/vendor/bootstrap-4.1/bootstrap.min.css' %}" rel="stylesheet" media="all">
   <!-- Vendor CSS-->
   <link href="{% static 'costmanagement/vendor/css-hamburgers/hamburgers.min.css' %}" rel="stylesheet" media="all">
   <link href="{% static 'costmanagement/vendor/datepicker/datepicker.css' %}" rel="stylesheet" media="all">
   <!-- Main CSS-->
   <link href="{% static 'costmanagement/css/style.css' %}" rel="stylesheet" media="all">
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

   <style>
      input[type="checkbox"] {
         height: 18px;
         width: 25px;
      }
   </style>
   <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/3.4.1/select2.min.css" rel="stylesheet">
   <link rel="stylesheet" type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-css/1.4.6/select2-bootstrap.min.css">
   <script type="text/javascript">
      $(document).ready(function () {
         $('#cosmumption_additivesname-input1').select2();
         $('#cosmumption_baseoilname-input1').select2();
      });

   </script>


   <script type="text/javascript">
      var countadditive = 1;
      var countoil = 1;

      // In your Javascript (external .js resource or <script> tag)

      $(document).ready(function () {

         $('.addadditive').click(function () {
            var $div = $('div[id^="additive-block"]:last');
            var num = parseInt($div.prop("id").match(/\d+/g), 10) + 1;

            var $clone = $div.clone().prop('id', 'additive-block' + num);
            $clone.find(".select2-container").remove();
            $clone.find(".js-select2").select2();


            $clone.find('#cosmumption_additivesname-input' + (num - 1)).prop('name', 'cosmumption_additivesname-input' + num);
            $clone.find('#cosmumption_additivesname-input' + (num - 1)).prop('id', 'cosmumption_additivesname-input' + num);
            $clone.find('#cosmumption_additivesname-input' + num).val("").end();
            

            $clone.find('#cosmumption_additivesquantity_percent-input' + (num - 1)).prop('name', 'cosmumption_additivesquantity_percent-input' + num);
            $clone.find('#cosmumption_additivesquantity_percent-input' + (num - 1)).prop('id', 'cosmumption_additivesquantity_percent-input' + num);
            $clone.find('#cosmumption_additivesquantity_percent-input' + num).val("").end();

            $clone.find('#cosmumption_additivesquantity_liter-input' + (num - 1)).prop('name', 'cosmumption_additivesquantity_liter-input' + num);
            $clone.find('#cosmumption_additivesquantity_liter-input' + (num - 1)).prop('id', 'cosmumption_additivesquantity_liter-input' + num);
            $clone.find('#cosmumption_additivesquantity_liter-input' + num).val("").end();

            $clone.find('#blendingcost_additivesvalue-input' + (num - 1)).prop('name', 'blendingcost_additivesvalue-input' + num);
            $clone.find('#blendingcost_additivesvalue-input' + (num - 1)).prop('id', 'blendingcost_additivesvalue-input' + num);
            $clone.find('#blendingcost_additivesvalue-input' + num).val("").end();
            $("#cosmumption_additivesname-input"+num).removeClass("js-select2");
            $div.after($clone);
            countadditive = countadditive + 1;
            $('#count-additive').val(countadditive);

         });

         $('.addbaseoil').click(function () {
           
            var $div = $('div[id^="baseoil-block"]:last');
            var num = parseInt($div.prop("id").match(/\d+/g), 10) + 1;
         
            var $clone = $div.clone().prop('id', 'baseoil-block' + num);
            $clone.find(".select2-container").remove();
            $clone.find(".js-select2").select2();

            $clone.find('#cosmumption_baseoilname-input' + (num - 1)).prop('name', 'cosmumption_baseoilname-input' + num);
            $clone.find('#cosmumption_baseoilname-input' + (num - 1)).prop('id', 'cosmumption_baseoilname-input' + num);
            $clone.find('#cosmumption_baseoilname-input' + num).val("").end();

            $clone.find('#cosmumption_baseoilquantity_percent-input' + (num - 1)).prop('name', 'cosmumption_baseoilquantity_percent-input' + num);
            $clone.find('#cosmumption_baseoilquantity_percent-input' + (num - 1)).prop('id', 'cosmumption_baseoilquantity_percent-input' + num);
            $clone.find('#cosmumption_baseoilquantity_percent-input' + num).val("").end();

            $clone.find('#cosmumption_baseoilquantity_liter-input' + (num - 1)).prop('name', 'cosmumption_baseoilquantity_liter-input' + num);
            $clone.find('#cosmumption_baseoilquantity_liter-input' + (num - 1)).prop('id', 'cosmumption_baseoilquantity_liter-input' + num);
            $clone.find('#cosmumption_baseoilquantity_liter-input' + num).val("").end();

            $clone.find('#blendingcost_baseoilsvalue-input' + (num - 1)).prop('name', 'blendingcost_baseoilsvalue-input' + num);
            $clone.find('#blendingcost_baseoilsvalue-input' + (num - 1)).prop('id', 'blendingcost_baseoilsvalue-input' + num);
            $clone.find('#blendingcost_baseoilsvalue-input' + num).val("").end();

            $div.after($clone);

            countoil = countoil + 1;
            $('#count-oil').val(countoil);
         });
         $('#blendingcost_perlitercost-input').focusin(function () {
            var totalvalue = 0;
            var totalqty = 0;
            for (var i = 1; i <= countadditive; i++) {
               var $div = $('div[id^="additive-block' + i + '"]');


               var value = $div.find('#blendingcost_additivesvalue-input' + i).val();
               totalvalue = totalvalue + parseFloat(value);

               var qty = $div.find('#cosmumption_additivesquantity_liter-input' + i).val();
               totalqty = totalqty + parseFloat(qty);
            }
            for (var i = 1; i <= countoil; i++) {
               // alert(countoil);
               var $base = $('div[id^="baseoil-block' + i + '"]');
               var value = $base.find('#blendingcost_baseoilsvalue-input' + i).val();
               totalvalue = totalvalue + parseFloat(value);

               var qty = $base.find('#cosmumption_baseoilquantity_liter-input' + i).val();
               totalqty = totalqty + parseFloat(qty);
            }
            $('#blendingcost_totalvalue-input').val(totalvalue.toFixed(4));
            $('#consumption_volcrosscheck-input').val(totalqty.toFixed(4));

            var net = parseFloat($('#consumption_netblendingqnty-input').val());
            var cross = parseFloat($('#consumption_volcrosscheck-input').val());
            $('#blendingcost_crosscheck-input').val(((cross / net) * 100).toFixed(4));
            $('#blendingcost_perlitercost-input').val((totalvalue / net).toFixed(4));
         });

         $('.delete').click(function () {
            $.post("{% url 'costmanagement:deleteconsumption' %}",
               {
                  'product': this.value
               },
               function (data, status) {

               });
         });

         $('.excel').click(function () {
            $(this).attr('href', "{% url 'costmanagement:exportConsumption'%}");
         });

         $(document).on("focusout", ".qtyadditive", function () {
            // alert("in here");
            var i = parseInt(this.id.match(/\d+/g), 10);
            // alert(i);
            var netQty = parseFloat($('#consumption_netblendingqnty-input').val());
            var percent = parseFloat(this.value);
            $('#cosmumption_additivesquantity_liter-input' + i).val(((percent / 100) * netQty).toFixed(4));
            // // alert(num);
            $.post("{% url 'costmanagement:fillAdditiveOil'%}", {
               'name': $('#cosmumption_additivesname-input' + i).val(),
               'liters': $('#cosmumption_additivesquantity_liter-input' + i).val(),
               'types': 'additives',
            },
               function (data, status) {
                  $('#blendingcost_additivesvalue-input' + i).val(data.value.toFixed(4));
               });
         });

         $(document).on("focusout", ".qtyoil", function () {
            // alert("in here");
            var i = parseInt(this.id.match(/\d+/g), 10);
            // alert(i);
            var netQty = parseFloat($('#consumption_netblendingqnty-input').val());
            var percent = parseFloat(this.value);
            $('#cosmumption_baseoilquantity_liter-input' + i).val(((percent / 100) * netQty).toFixed(4));
            // // alert(num);
            $.post("{% url 'costmanagement:fillAdditiveOil'%}", {
               'name': $('#cosmumption_baseoilname-input' + i).val(),
               'liters': $('#cosmumption_baseoilquantity_liter-input' + i).val(),
               'types': 'oils',
            },
               function (data, status) {
                  $('#blendingcost_baseoilsvalue-input' + i).val(data.value.toFixed(4));
               });
         });
         $("#consumption_date-input-date").datepicker({

         }).on("changeDate", function (e) {
            var d = new Date();
            d = e.date;
            d = (d.getDate()) + '/' + (d.getMonth() + 1) + '/' + d.getFullYear();

            $('#consumption_date-input').val(d);
         });

         $("#edit-consumption_date-input-date").datepicker({

         }).on("changeDate", function (e) {
            var d = new Date();
            d = e.date;
            d = (d.getDate()) + '/' + (d.getMonth() + 1) + '/' + d.getFullYear();

            $('#edit-consumption_date-input').val(d);
            // console.log(e.date);
            // alert('hi');
         });
         $(".table-search-product").on("keyup", function () {
            var value = $(this).val().toLowerCase(),
               tableattr = $(this).attr("data-table-search"),
               tablesearch = $('#' + tableattr).find('tbody tr');

            tablesearch.hide();                           //start with all rows hidden
            //initiate our stored rowspan with the default of 1

            tablesearch.each(function () {
               var $row = $(this);
               var $firstCell = $row.find("td:nth-child(3)");
               var id = $firstCell.text().toLowerCase();
               if (id.indexOf(value) > -1) {               //if the text is found
                  $row.show();         //show this row, and the next (n-1) rows as well
               }

            });
         });



      });

   </script>
</head>
{% include 'header.html'%}
<!-- MAIN CONTENT-->
<div class="main-content">
   <div class="section__content section__content--p30">
      <div class="container-fluid">
         <div class="headingrow">
            <button type="button" class="btn btn-primary new" data-toggle="modal" data-target="#entry0">
               New Request
            </button>
         </div>
         <div class="headingtitle">
            <div class="title">
               <h3>Blending & Consumption Details</h3>
            </div>

            <input type="text" placeholder="Filter Using Product" class='table-search-product'
               data-table-search="myTable"></input>

         </div>
      </div>
      <div class="boxone drag">
         <div class="scroller">
            <table class="table table0 table-striped table-dark table-bordered" id="myTable">
               <thead>
                  <tr>
                     <!-- <th scope="col">S.N</th> -->
                     <th scope="col">S.N</th>
                     <th scope="col">Blending Date</th>
                     <th scope="col">Product Name</th>
                     <th scope="col">Grade</th>
                     <th scope="col">SAE/ISO</th>
                     <th scope="col">Net Blending Quantity</th>
                     <th scope="col">Per Liter Cost</th>
                     <th scope="col">Approved</th>
                     <th scope="col">Status</th>
                  </tr>
               </thead>
               <tbody>
                  {% for i in records %}
                  <tr>
                     <td>{{i.sn}}</td>
                     <td>{{i.date}}</td>
                     <td>{{i.product}}</td>
                     <td>{{i.grade}}</td>
                     <td>{{i.sae}}</td>
                     <td>{{i.netBlendingQty|floatformat:4}}</td>
                     <td>{{i.perLiterCost|floatformat:4}}</td>
                     {% if i.approved %}
                     <td><input class="form-control-lg" type="checkbox" checked></td>
                     {% else %}
                     <td><input class="form-control-lg" type="checkbox"></td>
                     {% endif %}
                     <td>

                        <input type="button" class="btn btn-primary primary"
                           onclick='location.href="{% url 'costmanagement:consumptionview' product=i.product %}"'
                           value="View">
                        {% if user.authority == 'Manager 2'%}
                        <button type="button" class="btn btn-danger delete" value="{{i.product}}">Delete</button>
                        {%endif%}
                        {% comment %}
                        {% if user.authority == 'Manager 2' or user.authority == 'Chemist' or user.authority == 'Manager 1' %}
                        <button class="btn btn-primary approve" value="{{i.product}}">Approve</button>
                        {% endif %}
                        {% endcomment %}
                     </td>
                  </tr>
                  {% endfor %}
               </tbody>
            </table>
         </div>
      </div>
   </div>
   <div class="modal fade" id="entry0" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
         <div class="modal-content">
            <div class="modal-header">
               <h3 class="modal-title title" id="exampleModalLabel">Blending & Consumption Entry Data</h3>
               <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
               </button>
            </div>
            <div class="modal-body">
               <div class="card-body card-block">
                  <form action="{% url 'costmanagement:saveconsumption'%}" method="post" enctype="multipart/form-data"
                     class="form-horizontal">
                     {% csrf_token %}
                     <div class="row form-group">
                        <div class="col-md-6">
                           <label for="consumption_sn" class="form-control-label">S.N</label>
                           <input type="text" id="consumption_sn" value="{{sn}}" name="consumption_sn"
                              class="form-control">
                        </div>
                        <div class="col-md-6">
                           <label for="consumption_date" class="form-control-label">Date</label>
                           <!-- <input type="text" id="consumption_date" name="consumption_date" class="form-control"> -->
                           <div class="datefield">
                              <input type="text" class="form-control" id="consumption_date-input"
                                 name="consumption_date-input">
                              <span>
                                 <i class="fa fa-calendar date" id="consumption_date-input-date"></i>
                              </span>
                           </div>
                        </div>
                     </div>

                     <div class="additives">
                        <div class="heading">
                           <h4 class="tradetitle"> Additives</h4>
                        </div>
                        <div id="additive">
                           <div id="additive-block1">
                              <div class="row form-group">
                                 <div class="col-md-6">
                                    <label for="cosmumption_additivesname-input" class="form-control-label">Name</label>

                                    <select id="cosmumption_additivesname-input1"
                                       name="cosmumption_additivesname-input1"
                                       class="form-control cosmumption_additivesname-input js-select2">
                                       {% for i in additives %}
                                       {% if i.approved %}
                                       <option value="{{i.product}}">{{i.product}}</option>
                                       {% endif %}
                                       {%endfor%}
                                    </select>
                                    
                                   
                                 </div>
                                 <div class="col col-md-6">
                                    <label for="cosmumption_additivesquantity_percent-input"
                                       class=" form-control-label">Quantity in %</label>
                                    <input type="text" id="cosmumption_additivesquantity_percent-input1"
                                       name="cosmumption_additivesquantity_percent-input1"
                                       class="form-control qtyadditive">
                                 </div>
                              </div>
                              <div class="row form-group">
                                 <div class="col col-md-6">
                                    <label for="cosmumption_additivesquantity_liter-input"
                                       class=" form-control-label">Quantity in liters</label>
                                    <input type="text" id="cosmumption_additivesquantity_liter-input1"
                                       name="cosmumption_additivesquantity_liter-input1" class="form-control">
                                 </div>
                                 <div class="col col-md-6">
                                    <label for="blendingcost_additivesvalue-input"
                                       class=" form-control-label">Value</label>
                                    <input type="text" id="blendingcost_additivesvalue-input1"
                                       name="blendingcost_additivesvalue-input1" class="form-control value">
                                 </div>

                              </div>
                           </div>

                        </div>
                        <input type="hidden" value="1" id="count-additive" name="count-additive" />
                        <input type="button" class="btn btn-primary addadditive" value="Add More">
                     </div>

                     <div class="baseoils">
                        <div class="heading">
                           <h4 class="tradetitle"> Base oils</h4>
                        </div>
                        <div id="baseoil">
                           <div id="baseoil-block1">
                              <div class="row form-group">
                                 <div class="col col-md-6">
                                    <label for="cosmumption_baseoilname-input" class=" form-control-label">Name</label>
                                    <select id="cosmumption_baseoilname-input1" name="cosmumption_baseoilname-input1"
                                       class="form-control cosmumption_baseoilname-input js-select2">
                                       <!-- <option value="product1">Product1</option>
                                    <option value="product2">Product2</option>
                                    <option value="product3">Product3</option> -->
                                       {%for i in raw %}
                                       {% if i.approved %}
                                       <option value="{{i.product}}">{{i.product}}</option>
                                       {% endif %}
                                       {% endfor %}
                                    </select>
                                    <!-- <input type="text" id="cosmumption_baseoilname-input" name="cosmumption_baseoilname-input1" class="form-control"> -->
                                 </div>
                                 <div class="col col-md-6">
                                    <label for="cosmumption_baseoilquantity_percent-input"
                                       class=" form-control-label">Quantity in %</label>
                                    <input type="text" id="cosmumption_baseoilquantity_percent-input1"
                                       name="cosmumption_baseoilquantity_percent-input1" class="form-control qtyoil">
                                 </div>
                              </div>
                              <div class="row form-group">
                                 <div class="col col-md-6">
                                    <label for="cosmumption_baseoilquantity_liter-input"
                                       class=" form-control-label">Quantity in Liters</label>
                                    <input type="text" id="cosmumption_baseoilquantity_liter-input1"
                                       name="cosmumption_baseoilquantity_liter-input1" class="form-control">
                                 </div>
                                 <div class="col col-md-6">
                                    <label for="blendingcost_baseoilsvalue-input"
                                       class=" form-control-label">Value</label>
                                    <input type="text" id="blendingcost_baseoilsvalue-input1"
                                       name="blendingcost_baseoilsvalue-input1" class="form-control value">
                                 </div>
                              </div>
                           </div>
                        </div>
                        <input type="hidden" value="1" id="count-oil" name="count-oil" />
                        <input type="button" class="btn btn-primary addbaseoil" value="Add More">

                     </div>
                     <div class="heading">
                        <h4 class="tradetitle"> Product</h4>
                     </div>
                     <div class="row form-group">


                        <div class="col col-md-6">
                           <label for="consumption_productname-input" class=" form-control-label">Product Name</label>
                           <input type="text" id="consumption_productname-input" name="consumption_productname-input"
                              class="form-control">
                        </div>
                        <div class="col col-md-6">
                           <label for="consumption_grade-input" class=" form-control-label">Grade</label>
                           <input type="text" id="consumption_grade-input" name="consumption_grade-input"
                              class="form-control">
                        </div>
                     </div>
                     <div class="row form-group">
                        <div class="col col-md-4">
                           <label for="consumption_iso-input" class=" form-control-label">SAE/ISO</label>
                           <input type="text" id="consumption_iso-input" name="consumption_iso-input"
                              class="form-control">
                        </div>

                        <div class="col col-md-4">
                           <label for="consumption_netblendingqnty-input" class=" form-control-label">Net Blending
                              Quantity</label>
                           <input type="text" id="consumption_netblendingqnty-input"
                              name="consumption_netblendingqnty-input" class="form-control">
                        </div>
                        <div class="col col-md-4">
                           <label for="consumption_volcrosscheck-input" class=" form-control-label">Gross Vol
                              Crosscheck</label>
                           <input type="text" id="consumption_volcrosscheck-input"
                              name="consumption_volcrosscheck-input" class="form-control">
                        </div>
                     </div>
                     <div class="row form-group">
                        <div class="col col-md-4">
                           <label for="blendingcost_crosscheck-input" class=" form-control-label">% Cross Check</label>
                           <input type="text" id="blendingcost_crosscheck-input" name="blendingcost_crosscheck-input"
                              class="form-control">
                        </div>
                        <div class="col col-md-4">
                           <label for="blendingcost_totalvalue-input" class=" form-control-label">Total value</label>
                           <input type="text" id="blendingcost_totalvalue-input" name="blendingcost_totalvalue-input"
                              class="form-control">
                        </div>
                        <div class="col col-md-4">
                           <label for="blendingcost_perlitercost-input" class=" form-control-label">Per Liter
                              Cost</label>
                           <input type="text" id="blendingcost_perlitercost-input"
                              name="blendingcost_perlitercost-input" class="form-control">
                        </div>
                     </div>
                     <div class="row form-group">
                        <div class="col-md-12">
                           <label for="blendingcost_remarks-input" class=" form-control-label">Remarks</label>
                           <input type="text" id="blendingcost_remarks-input" name="blendingcost_remarks-input"
                              class="form-control">
                        </div>
                     </div>

               </div>
               <div class="modal-footer">
                  <!--	<button class="btn btn-primary approve" id="consumption-approve"  value="">Approve</button>-->
                  <input type="submit" class="btn btn-primary" value="Save Details">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
               </div>
               </form>
            </div>
         </div>

      </div>
   </div>
</div>
</div>
{% include 'footer.html'%}
</div>
</div>
</body>

</html>
<!-- end document